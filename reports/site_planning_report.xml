<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Site Planning Report Template -->
    <template id="report_site_planning_document">
        <t t-call="web.external_layout">
            <div class="page">
                <div class="text-center mb-4">
                    <h2 class="mt-0">
                        <strong>Planning du Site</strong>
                    </h2>
                </div>

                <!-- Site Information -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card" style="border-left: 4px solid #875a7b;">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <table class="table table-sm table-borderless">
                                            <tr>
                                                <td class="text-end" style="width: 40%;"><strong>Site:</strong></td>
                                                <td><span t-field="doc.name"/></td>
                                            </tr>
                                            <tr>
                                                <td class="text-end"><strong>Code:</strong></td>
                                                <td><span t-field="doc.site_code"/></td>
                                            </tr>
                                            <tr t-if="doc.partner_id">
                                                <td class="text-end"><strong>Client:</strong></td>
                                                <td><span t-field="doc.partner_id.name"/></td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-6">
                                        <table class="table table-sm table-borderless">
                                            <tr t-if="doc.city">
                                                <td class="text-end" style="width: 40%;"><strong>Ville:</strong></td>
                                                <td><span t-field="doc.city"/></td>
                                            </tr>
                                            <tr t-if="doc.phone">
                                                <td class="text-end"><strong>Téléphone:</strong></td>
                                                <td><span t-field="doc.phone"/></td>
                                            </tr>
                                            <tr>
                                                <td class="text-end"><strong>Agents affectés:</strong></td>
                                                <td><span class="badge bg-primary" t-esc="len(doc.agent_ids)"/></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Planning per Agent -->
                <t t-if="doc.agent_ids">
                    <div class="mb-3">
                        <h4>
                            <i class="fa fa-users"/> Plannings des agents du site
                        </h4>
                    </div>

                    <t t-foreach="doc.agent_ids" t-as="agent">
                        <t t-set="agent_plannings" t-value="env['acs.planning'].search([('employee_id', '=', agent.id)], order='start_date desc', limit=50)"/>
                        
                        <!-- Agent Header -->
                        <div class="mt-4 mb-2">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-8">
                                            <h5 class="mb-0">
                                                <i class="fa fa-user text-primary"/> 
                                                <span t-field="agent.name"/>
                                            </h5>
                                            <small class="text-muted">
                                                <span t-if="agent.barcode">Badge: <span t-field="agent.barcode"/> - </span>
                                                <span t-if="agent.job_title" t-field="agent.job_title"/>
                                            </small>
                                        </div>
                                        <div class="col-4 text-end">
                                            <span class="badge bg-info fs-6">
                                                <span t-esc="len(agent_plannings)"/> planning(s)
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Agent Planning Table -->
                        <t t-if="agent_plannings">
                            <table class="table table-sm table-bordered">
                                <thead style="background-color:#875a7b; color:white;">
                                    <tr>
                                        <th class="text-center" style="width: 5%;">#</th>
                                        <th class="text-center" style="width: 12%;">Date</th>
                                        <th class="text-center" style="width: 12%;">Début</th>
                                        <th class="text-center" style="width: 12%;">Fin</th>
                                        <th class="text-center" style="width: 18%;">Horaire</th>
                                        <th class="text-center" style="width: 23%;">Lieu de travail</th>
                                        <th class="text-center" style="width: 18%;">Statut</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="agent_plannings" t-as="planning">
                                        <td class="text-center">
                                            <span t-esc="planning_index + 1"/>
                                        </td>
                                        <td class="text-center">
                                            <span t-field="planning.date"/>
                                        </td>
                                        <td class="text-center">
                                            <span t-field="planning.start_date" t-options='{"widget": "datetime", "format": "HH:mm"}'/>
                                        </td>
                                        <td class="text-center">
                                            <span t-field="planning.end_date" t-options='{"widget": "datetime", "format": "HH:mm"}'/>
                                        </td>
                                        <td class="text-center">
                                            <span t-if="planning.schedule_id" t-field="planning.schedule_id.name"/>
                                            <span t-else="">-</span>
                                        </td>
                                        <td class="text-center">
                                            <span t-if="planning.work_location_id" t-field="planning.work_location_id.name"/>
                                            <span t-else="">-</span>
                                        </td>
                                        <td class="text-center">
                                            <t t-if="planning.state == 'draft'">
                                                <span class="badge bg-secondary">Brouillon</span>
                                            </t>
                                            <t t-elif="planning.state == 'waiting'">
                                                <span class="badge bg-warning">En attente</span>
                                            </t>
                                            <t t-elif="planning.state == 'approved'">
                                                <span class="badge bg-success">Approuvé</span>
                                            </t>
                                            <t t-elif="planning.state == 'done'">
                                                <span class="badge bg-info">Terminé</span>
                                            </t>
                                            <t t-else="">
                                                <span class="badge bg-danger">Annulé</span>
                                            </t>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </t>
                        <t t-else="">
                            <div class="alert alert-warning text-center" role="alert">
                                <i class="fa fa-exclamation-triangle"/> Aucun planning trouvé pour cet agent.
                            </div>
                        </t>
                    </t>

                    <!-- Overall Statistics -->
                    <t t-set="all_site_plannings" t-value="env['acs.planning'].search([('employee_id', 'in', doc.agent_ids.ids)])"/>
                    <div class="row mt-5">
                        <div class="col-12">
                            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <div class="card-body">
                                    <h5 class="text-white mb-3">
                                        <i class="fa fa-bar-chart"/> Statistiques globales du site
                                    </h5>
                                    <div class="row text-center">
                                        <div class="col-3">
                                            <div class="bg-white bg-opacity-25 rounded p-3">
                                                <h3 class="mb-0" t-esc="len(all_site_plannings)"/>
                                                <small>Total plannings</small>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="bg-white bg-opacity-25 rounded p-3">
                                                <t t-set="approved_count" t-value="len(all_site_plannings.filtered(lambda p: p.state == 'approved'))"/>
                                                <h3 class="mb-0" t-esc="approved_count"/>
                                                <small>Approuvés</small>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="bg-white bg-opacity-25 rounded p-3">
                                                <t t-set="done_count" t-value="len(all_site_plannings.filtered(lambda p: p.state == 'done'))"/>
                                                <h3 class="mb-0" t-esc="done_count"/>
                                                <small>Terminés</small>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="bg-white bg-opacity-25 rounded p-3">
                                                <h3 class="mb-0" t-esc="len(doc.agent_ids)"/>
                                                <small>Agents</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </t>

                <t t-else="">
                    <div class="alert alert-info text-center" role="alert">
                        <i class="fa fa-info-circle"/> Aucun agent affecté à ce site.
                    </div>
                </t>

                <!-- Footer with generation date -->
                <div class="row mt-4">
                    <div class="col-12 text-end text-muted">
                        <small>
                            Rapport généré le <span t-esc="context_timestamp(datetime.datetime.now()).strftime('%d/%m/%Y à %H:%M')"/>
                        </small>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <template id="report_site_planning">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="acs_planning_reports.report_site_planning_document"/>
            </t>
        </t>
    </template>

    <!-- Report Action -->
    <record id="action_report_site_planning" model="ir.actions.report">
        <field name="name">Planning Site</field>
        <field name="model">site.site</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">acs_planning_reports.report_site_planning</field>
        <field name="report_file">acs_planning_reports.report_site_planning</field>
        <field name="binding_model_id" ref="site_ange_security.model_site_site"/>
        <field name="binding_type">report</field>
        <field name="print_report_name">'Planning Site - %s' % (object.name)</field>
    </record>

</odoo>
